## 작업내역 과 작업 만들기

- 이제 클러스터에서 어떠한 작업을 진행해야 하는지를 지시해주는 작업내역(task definition)을 만들어 보자.

- 클러스터 밑에 작업정의를 선택한 후 새 작업정의 생성을 선택하자.

- 시작 유형 호완성 선택에서 Fargate를 선택한다.

  - 작업 정의 이름을 정해주자 web, api등등

  - 작업 역할은 없음으로 하면 나중에 ecsTaskExecutionRole이라고 작업 역활을 AWS가 자동으로 생성해준다.

  - 작업실행 IAM역활도 마찬가지이다.

  - 작업크기는 최소단위인 메모리 0.5G, cpu 0.25로 한다. 단 spring boot등으로 만든 컨테이너는 작업크기를 2배로 해주자. 그 이유는 다음과 같다.

  - 여기서 서비스가 실행되지 않아서 매우 많이 고생했다. 알수 있던건 테스크 데피니션을 실행하기 전에 꼭 `docker stats` 를 실행해서 해당 컨데이터가 실행되는 메모리의 크기를 확인하도록 한다. 그러지 않으면 서비스가 바로 죽어버린다. 이거 해결을 하기 위해 하루 이상을 허비했다.

    ```shell
    Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused "process_linux.go:297: getting the final child's pid from pipe caused \"read init-p: connection reset by peer\"": unknown
    ```

    이러한 메세지 등을 보며 도커의 컨테이너가 실행되지 않음을 볼 수 있다. 그래서 api는 메모리 1024, cpu 0.5로 설정했다.

- 이제 컨테이너의 설정을 하는 컨테이너 정의를 보자. 여기에 도커로 생성한 컨테이너를 넣어주는 것이다.

  - 컨테이너 이름은 각자 알아서
  - 이미지는 ECR의 주소를 다 복사하면 됩니다.
  - 메모리 제한은 소프트 제한으로 위의 작업크기에서 정한 용량을 알아서 주자(그런데 하나의 컨테이너가 하나의 작업정의에 설정되므로 다 주자.)
  - 포트맵핑은 여러분들이 더 잘 아실테니 열어주자. 단 여기서는 내 외부 포트번호를 다르게 주는 것을 할 수 없다.
  - 아래를 보면 환경이라는 부분이 있다. 여기서 CPU단위라는 것이 있는데 여기도 작업크기에서 정한 용량을 줘야 한다.
  - 더 내려가면 **환경변수** 라는 항목이 있다. 참고로 아래는 개발서버에서 도커를 실행시키는 명령을 일부 가져왔다.

  ```shell
  # 아래의 -e 뒤에 붙은 NODE_ENV가 key 뒤의 dev가 value이다. 이것을 적어주면 도커 실행시 값이 들어간다.
  docker run -d -p 80:80 --network docker-net -e NODE_ENV=dev --name web-server 000000000000.dkr.ecr.ap-northeast-2.amazonaws.com/sample/web
  ```

  - 로깅은 나중에 cloud watch등에서 로그를 볼수 있게 해주는 부분이다. 거의 기본값으로 해도 되긴 하다.

#### 3. 작업 만들기

작업내역 만으로는 실행이 되지 않는다. 이것은 작업의 정의를 내리기 위한 것이기 때문이다. 이것이 실 작동하는게 작업, 외부로 연결하는게 서비스이다. 이것까지 되어야 된다.

- 새 작업 실행 선택
- 시작유형은 FARGATE이고 작업정의는 위에서 만든 작업정의를 사용한다.
- 버전 및 클러스터를 맞추고 작업개수는 1개를 설정한다.
- VPC 설정 후 서브넷은 두개 다 선택한다.
- 보안그룹을 세팅하자. 우선 웹서버를 올릴거니까 모든 곳에서 80포트는 허용을 하자.
- 자동 할당 퍼블릭 IP는 ENABLED를 설정하면 Fargate가 직접 아이피를 할당한다.
- 작업실행을 클릭하자.
- 원하는 상태가 RUNNING이 되면 재대로 작동하는 것이다. 작업이 RUNNING이 되면 들어가서 퍼블릭 아이피를 보자 이 주소로 접속이 가능하다. 그런데 저렇게 하면 하나의 인스턴스에 그냥 연결하는 거나 마찬가지다. 이것은 로드밸런서를 만들어서 서비스로 연결하여 줘야 한다.