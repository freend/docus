# ECS에 서비스 올리기

### 선행정보

- 작성일 : 2020-03-18
- 아래 내용중에 책이라는 항목이 있는데 책 제목은 '당신이 지금 알아야 할 AWS'이다.
- 아래는 ECS 컨테이너 서비스 구축에 있는 내용을 정리한 것이다.

### 시작하기 전에

- VPC, SubNet, Route Table, Internet Gateway에 각각 Default의 이름을 적어두기 바란다.
- 왜냐하면 시작하기를 통해서 ECS를 만들면 알아서 이름을 정의해 주지만(security group, load balacer등은 예외) 나머지는 이름을 만들어준다. 단 수동으로 클러스터 만들고 하면 이름이 공란이 되므로 햇갈리지 않게 미리 넣어주는게 좋다.
- 모르겠거나 오류가 발생한다면 ECS 에서 시작하기로 먼저 시작한 후 각 경우에서 편집을 눌러서 어느정도 기능을 알아 본 후 하는것도 좋다.
- task definition은 안 지워지므로 이름을 Sample같은 거로 적지 말자. 추후 작업정의를 변경하려면 작업정의를 선택한 후 세 계정을 만든 후 전의 작업정의를 사용하고 있던 task나 service의 버전을 변경해주면 된다.
- 클러스터는 지워도 된다(안지우면 돈이다) 그런데 삭제하다 보면 지우는걸 실패하는 경우가 있다. 이땐 VPC에서 VPC, SubNet, Route Table, Internet Gateway를 지운 후 클러스터를 삭제하자(단 삭제순서는 반대다 VPC를 맨 마지막에 지워주자)

### 오류수정

- 나의 경우 책에 적힌대로 하다가 애러가 발생했다, 그래서 시작하기로 샘플 돌려보니 여긴 CPU할당을 걸어두었다. 그래서 나도 CPU 할당을 진행한 후 실행하니 정상적으로 Fargate를 통한 통신이 이루어졌다.

- 책에 해당 부분의 내용을 설명할 때 환경에서 스크립트가 존재하지 않는다. 그것은 시작하기에서 컨테이너 정의를 sample-app에 두고 '편집'을 선택한 후 '고급 컨테이너 구성'을 보면 '명령'에 존재한다. 또한 여기서 CPU단위에 할당을 해야 되는것도 알게 되었다.

- 업데이트 시에는 auto scaling에 의한 작업량 변경만이 가능한 듯 하다. 따라서 새로운 작업정의를 만들어야 한다.

### 작업내역

- 우선 기본 서비스 말고 나의 서비스가 정상적으로 실행되는지 확인하기
  
  - 테스크 까지 해서 퍼블릭 아이피로 접근 확인
  
- 그런데 퍼블릭 아이피를 80으로 해 놓아도 3000으로 접근이 됨
  - ECS EC2에서는 시스템이 host port와 container port를 맞추는데 여기서는 그렇지 않음.
  - Rendering server에서 3000을 80으로 변경하도록 함.
  
- 같은 task 안에서는 localhost로 통신이 되는 것을 확인함. 이때 task definition에서 awsvpc 네트워크를 사용해야 한다.

- RDS 서비스를 추가하고 api server랑 RDS랑 통신이 되게 만들고 web과 api는 서로 localhost로 통신이 되게 하나의 task안에 위치시키면 될 거 같음.

  > 위와 같이 진행하려고 하니 auto scale out시 web과 api가 동시에 늘어나는 문제가 발생하게 되었다. 이건 비효율적인 것이라 생각하고 어딘가에서 읽었는데 하나의 작업정의에는 하나의 container만 있는게 좋다고 해서 그렇게 하기로 했다.

### 개선내용

- web과 api를 각각의 task로 분리
- 그 후 web과 api를 각각 alb로 연결
- RDS를 보안을 위해 ECS의 VPC로 이관하여 RDS에 접근 허용을 기본 보안그룹 허용으로 하면 api에서 rds로 연결이 가능하다.

### Environment설정

- ecs에서 environment는 어디서 설정하는지 궁금했다. 이것은 작업정의에서 컨테이너 설정을 할때 환경에 변수 부분에 key, value로 작성하면 적용된다.

### ECS에 SES 적용하기.

- [링크](../SES/README.md)

